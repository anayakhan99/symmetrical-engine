name: "RDP Chain Deployment"

on:
  workflow_dispatch:
    inputs:
      NODE:
        description: "Node number to launch (e.g., 1, 2, 3...)"
        required: true
        default: "1"

jobs:
  deploy-node:
    name: "Deploy Node ${{ github.event.inputs.NODE }}"
    runs-on: windows-latest
    timeout-minutes: 30

    env:
      NODE_ID: ${{ github.event.inputs.NODE }}
      GH_PAT: ${{ secrets.GH_PAT }}
      NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "rdp-chain.yml"

    steps:
      - name: üßæ Log Node Info
        shell: pwsh
        run: |
          Write-Host "=================================================="
          Write-Host "üü¢ NODE_ID           : $env:NODE_ID"
          Write-Host "üì¶ GITHUB_REPOSITORY : $env:REPO"
          Write-Host "üîÅ WORKFLOW_FILE     : $env:WORKFLOW_FILE"
          Write-Host "=================================================="

      - name: üîê Validate Required Secrets
        shell: pwsh
        run: |
          if (-not $env:GH_PAT) {
            Write-Error "‚ùå Missing GitHub PAT."
            exit 1
          }
          if (-not $env:NGROK_AUTH_TOKEN) {
            Write-Error "‚ùå Missing NGROK_AUTH_TOKEN."
            exit 1
          }

      - name: üì• Download rdp-node.ps1 (from GitLab)
        shell: pwsh
        run: |
          $url = "https://gitlab.com/Shahzaib-YT/ngrok-multi-nodes/-/raw/main/rdp-node.ps1"
          Write-Host "üì° Downloading rdp-node.ps1..."
          Invoke-WebRequest -Uri $url -OutFile "rdp-node.ps1" -UseBasicParsing
          if (!(Test-Path "./rdp-node.ps1")) {
            Write-Error "‚ùå Failed to download rdp-node.ps1"
            exit 1
          }
          Write-Host "‚úÖ rdp-node.ps1 successfully downloaded."

      - name: üöÄ Execute rdp-node.ps1
        shell: pwsh
        run: |
          Write-Host "üö¶ Executing rdp-node.ps1 with ExecutionPolicy Bypass"
          powershell.exe -ExecutionPolicy Bypass -File ".\rdp-node.ps1"
